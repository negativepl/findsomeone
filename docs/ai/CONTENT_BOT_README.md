# Content Bot - Automatic Listing Generation

## Overview

Content Bot is an AI-powered system for automatic generation of sample listings using GPT-4o mini. The system fills categories with content that:
- Is natural and authentic (sounds like written by real users)
- Contains images from Unsplash matched to categories
- Is marked as "AI Generated"
- Has realistic prices and locations

## Features

**Automatic Post Generation**
- Titles and descriptions generated by GPT-4o mini
- Random cities from across Poland
- Realistic prices for each category
- Mix of "Looking for" and "Offering" posts (configurable ratio)

**Image Integration**
- Automatic image fetching from Unsplash API
- Images matched to categories (e.g., for "Plumbing" → plumbing tools images)
- Fallback without images if API unavailable

**Admin Panel**
- Live progress bar during generation
- Statistics of generated posts
- Delete all AI posts with one click

**Visual AI Badge**
- Purple-pink "AI" badge with Sparkles icon
- Visible on post lists and detail pages
- Responsive sizes (sm/md/lg)

## Installation

### 1. Run Migrations

The necessary migrations for Content Bot are included in the main migration files:
- AI-generated posts flag and bot account setup
- Bot settings in `ai_settings` table

**For new installations:** Use `supabase/migrations_consolidated/` (migrations already included)

**For existing installations:** Check if bot account exists:
```sql
SELECT * FROM profiles WHERE email = 'contentbot@example.com';
```

If not, apply the AI-related migrations from `supabase/migrations/` or see `/supabase/MIGRATIONS_README.md` for guidance.

### 2. Environment Variables Configuration

Add to `.env.local`:

```bash
# Required
OPENAI_API_KEY=sk-xxx  # Your OpenAI API key

# Optional (without this posts will have no images)
UNSPLASH_ACCESS_KEY=xxx  # Your Unsplash API key
```

#### How to Get Unsplash Key:
1. Go to https://unsplash.com/developers
2. Register / Log in
3. Create new application ("New Application")
4. Copy "Access Key"
5. **Important**: Free tier = 50 requests/hour

### 3. Restart Server

```bash
npm run dev
```

## Usage

### Admin Panel

Go to: **`https://your-domain.app/admin/content-bot`**

#### Generating Posts:

1. Click **"Generate Listings for All Categories"**
2. Confirm dialog (operation may take 5-10 minutes for ~500 posts)
3. Watch progress bar:
   - Shows current progress (e.g., "35 / 170")
   - Displays category name being processed
   - Shows post type (Looking for/Offering)

#### Deleting AI Posts:

1. Click **"Delete All AI Listings (X)"**
2. Confirm dialog
3. All posts with `is_ai_generated = true` will be deleted

### Configuration (in AI Settings)

Bot settings are in `ai_settings` table:

```sql
SELECT
  content_bot_system_message,     -- System message for GPT
  content_bot_prompt,              -- Prompt template
  content_bot_model,               -- Model (default: gpt-4o-mini)
  content_bot_posts_per_category,  -- Posts per category (default: 3)
  content_bot_offering_ratio       -- "Offering" ratio (0.5 = 50%)
FROM ai_settings;
```

#### Change Looking for/Offering Ratio:

```sql
UPDATE ai_settings
SET content_bot_offering_ratio = 0.7  -- 70% offering, 30% looking for
WHERE id = '00000000-0000-0000-0000-000000000001';
```

#### Change Posts Per Category:

```sql
UPDATE ai_settings
SET content_bot_posts_per_category = 5  -- 5 posts instead of 3
WHERE id = '00000000-0000-0000-0000-000000000001';
```

## Technical Structure

### Backend Files:

- **`lib/unsplash.ts`** - Helper for fetching images from Unsplash
- **`app/api/admin/content-bot/generate-post/route.ts`** - Endpoint for generating single post
- **`app/api/admin/content-bot/generate-bulk/route.ts`** - Streaming endpoint for bulk generation
- **`app/api/admin/content-bot/delete-all/route.ts`** - Endpoint for deleting/counting AI posts

### Frontend Files:

- **`components/admin/ContentBotPanel.tsx`** - Admin panel
- **`components/AIGeneratedBadge.tsx`** - AI badge component
- **`app/admin/content-bot/page.tsx`** - Panel page

### Database Schema:

- **`is_ai_generated` column** in `posts` table - Flags AI-generated content
- **Bot account** - System user for AI-generated posts
- **Bot settings** in `ai_settings` table - Configurable prompts and parameters

All migrations are included in the consolidated migrations (see `/supabase/MIGRATIONS_README.md`).

## Technical Details

### Bot Account

- **User ID**: `00000000-0000-0000-0000-000000000002`
- **Email**: `contentbot@example.com`
- **Full Name**: "FindSomeone Bot"
- **Verified**: `true`
- All AI posts belong to this account

### Post Generation

1. Bot fetches all categories from database
2. For each category:
   - Randomly selects city from list of 27 Polish cities
   - Generates post type (seeking/offering) according to ratio
   - Calls GPT-4o mini with prompt
   - Parses JSON response (title, description, price_min, price_max, price_type)
   - Fetches image from Unsplash (if available)
   - Creates post with flag `is_ai_generated = true`
3. 500ms delay between posts (rate limiting)

### JSON Format from GPT:

```json
{
  "title": "Looking for plumber in Warsaw - urgent",
  "description": "Need tap repair in bathroom. Leaking since yesterday. Bemowo area, can pay cash.",
  "price_min": 80,
  "price_max": 150,
  "price_type": "fixed"
}
```

### Category to Unsplash Search Terms Mapping

Examples:
- "Plumbing" → "plumber plumbing pipes"
- "Electrical" → "electrician electrical work"
- "Gardening" → "gardening plants landscaping"

Full list in: `lib/unsplash.ts` → `mapCategoryToSearchTerm()`

## Limits and Optimization

### Rate Limits:

- **OpenAI GPT-4o mini**: Theoretically unlimited, but 500ms delay added
- **Unsplash Free tier**: 50 requests/hour
  - For 170 categories × 3 posts = **510 requests** = **~11 hours** of generation
  - Or run without `UNSPLASH_ACCESS_KEY` (posts without images = faster)

### Generation Time:

- **Without images**: ~2-3 minutes for 500 posts
- **With images**: ~10-15 minutes (due to Unsplash rate limit)

### Optimization:

1. **Increase delay** if getting rate limit errors:
   ```typescript
   // In generate-bulk/route.ts, line 164
   await new Promise(resolve => setTimeout(resolve, 1000)) // 500ms → 1000ms
   ```

2. **Generate without images** for quick testing:
   - Remove `UNSPLASH_ACCESS_KEY` from `.env.local`
   - Bot will skip image fetching

3. **Paid Unsplash** (if you need more):
   - Plus plan: 5000 requests/hour
   - https://unsplash.com/pricing

## Troubleshooting

### Problem: "AI settings not found"
**Solution**: Check that bot settings exist in `ai_settings` table. See migration documentation in `/supabase/MIGRATIONS_README.md`.

### Problem: "No content generated" or GPT errors
**Solution**:
- Check `OPENAI_API_KEY` in `.env.local`
- Make sure you have access to GPT-4o mini
- Check API logs in console

### Problem: No images in posts
**Solution**:
- Add `UNSPLASH_ACCESS_KEY` to `.env.local`
- Check 50 requests/hour limit in Unsplash dashboard

### Problem: "Unauthorized" in endpoints
**Solution**: Make sure you are logged in as admin

### Problem: Progress bar freezes
**Solution**:
- Check browser console (F12)
- Make sure backend didn't return error
- Refresh page and try again

## FAQ

**Q: Can I edit AI-generated posts?**
A: Yes, they behave like normal posts. You can edit them in dashboard.

**Q: Are AI posts visible to all users?**
A: Yes, they are public and have "AI" badge so users know it's sample content.

**Q: Can I change cities the bot uses?**
A: Yes, edit `POLISH_CITIES` in `generate-bulk/route.ts` or `generate-post/route.ts`

**Q: Can I generate only for selected categories?**
A: Currently only "all categories". You can modify endpoint to accept `categoryIds[]`

**Q: How to change GPT prompt?**
A: Edit `content_bot_prompt` in `ai_settings` table via SQL or add UI in admin panel

## Extensions (TODO)

Possible future extensions:

- [ ] UI for editing bot settings in admin panel
- [ ] Select specific categories for generation
- [ ] Preview posts before saving
- [ ] Scheduled automatic generation
- [ ] DALL-E integration for custom images
- [ ] Export/import prompts
- [ ] A/B testing different prompts

## Support

In case of problems:
1. Check logs in browser console (F12)
2. Check API logs in terminal (`npm run dev`)
3. Check tables in Supabase SQL Editor
4. Report issue on GitHub

---

**Version**: 1.0.0
**Last Updated:** November 8, 2025
